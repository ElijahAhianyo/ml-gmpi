# Data Preprocess Prepare Landmarks Ffhq

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-Codebase Structure-start--->
## Codebase Structure

<!---Documatic-block-system_architecture-start--->
```mermaid
None
```
<!---Documatic-block-system_architecture-end--->

# #
<!---Documatic-section-Codebase Structure-end--->

<!---Documatic-section-data_preprocess.prepare_landmarks_ffhq.get_file_ext-start--->
## data_preprocess.prepare_landmarks_ffhq.get_file_ext

<!---Documatic-section-get_file_ext-start--->
<!---Documatic-block-data_preprocess.prepare_landmarks_ffhq.get_file_ext-start--->
<details>
	<summary><code>data_preprocess.prepare_landmarks_ffhq.get_file_ext</code> code snippet</summary>

```python
def get_file_ext(fname):
    return os.path.splitext(fname)[1].lower()
```
</details>
<!---Documatic-block-data_preprocess.prepare_landmarks_ffhq.get_file_ext-end--->
<!---Documatic-section-get_file_ext-end--->

# #
<!---Documatic-section-data_preprocess.prepare_landmarks_ffhq.get_file_ext-end--->

<!---Documatic-section-data_preprocess.prepare_landmarks_ffhq.main-start--->
## data_preprocess.prepare_landmarks_ffhq.main

<!---Documatic-section-main-start--->
```mermaid
flowchart LR
data_preprocess.prepare_landmarks_ffhq.main-->data_preprocess.prepare_landmarks_ffhq.get_file_ext
```

### Object Calls

* data_preprocess.prepare_landmarks_ffhq.get_file_ext

<!---Documatic-block-data_preprocess.prepare_landmarks_ffhq.main-start--->
<details>
	<summary><code>data_preprocess.prepare_landmarks_ffhq.main</code> code snippet</summary>

```python
def main(args):
    input_zipf = args.input_zipf
    detect_base_dir = os.path.join(args.save_dir, 'detections')
    detect_res_dir = os.path.join(detect_base_dir, 'results')
    os.makedirs(detect_res_dir, exist_ok=True)
    detector = MTCNN()
    zip_obj = zipfile.ZipFile(input_zipf)
    all_f_list = zip_obj.namelist()
    PIL.Image.init()
    all_img_f_list = [_ for _ in all_f_list if get_file_ext(_) in PIL.Image.EXTENSION]
    sorted_f_list = sorted(all_img_f_list)
    print('\nsorted_f_list: ', len(sorted_f_list), sorted_f_list[:5], '\n')
    for (i, filename) in tqdm.tqdm(enumerate(sorted_f_list), total=len(sorted_f_list)):
        sub_folder = os.path.join(detect_res_dir, filename.split('/')[0])
        os.makedirs(sub_folder, exist_ok=True)
        basename = os.path.splitext(filename)[0]
        with zip_obj.open(filename, 'r') as f:
            if pyspng is not None and get_file_ext(filename) == '.png':
                img = pyspng.load(f.read())
            else:
                img = np.array(PIL.Image.open(f))
        text_path = f'{detect_res_dir}/{basename}.txt'
        result = detector.detect_faces(img)
        try:
            keypoints = result[0]['keypoints']
            with open(text_path, 'w') as f:
                for value in keypoints.values():
                    f.write(f'{value[0]}\t{value[1]}\n')
        except:
            if i == 0:
                mode = 'w'
            else:
                mode = 'a'
            with open(os.path.join(detect_base_dir, 'fail_list.txt'), mode) as fail_f:
                fail_f.write(f'{filename}\n')
            print('\n', filename, filename, '\n')
    if not os.path.exists(os.path.join(detect_base_dir, 'fail_list.txt')):
        with open(os.path.join(detect_base_dir, 'fail_list.txt'), 'w') as fail_f:
            fail_f.write(f'\n')
```
</details>
<!---Documatic-block-data_preprocess.prepare_landmarks_ffhq.main-end--->
<!---Documatic-section-main-end--->

# #
<!---Documatic-section-data_preprocess.prepare_landmarks_ffhq.main-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)